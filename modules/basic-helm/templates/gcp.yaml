{% set workspace = '/workspace' %}   {# has to be a persistent volume #}
{% set pipeline_env_file = workspace|add:'/.env' %}
{% set pipeline_secret_file = workspace|add:'/.secret.env' %}
{% set pipeline_modules_path = workspace|add:'/pipeline_modules' %}
{% set source_code_path = workspace|add:'/source_code' %}

steps:
- id: 'gcloud container setup'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gcloud container clusters get-credentials {{cluster}} --region {{region}}
- id: 'Install helm'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git clone https://github.com/GoogleCloudPlatform/cloud-builders-community.git;
    cd cloud-builders-community/helm;
    docker build -t gcr.io/$PROJECT_ID/helm:latest . ;
{% if job_type == 'deploy' %}
- id: 'Install Application'
  name: 'gcr.io/$PROJECT_ID/helm'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    {%- if namespace != 'default' %}
    kubectl create ns {{namespace}}
    {%- endif %}
    cd {{source_code_path}} ;
    {%- if helm_chart_name != '' %} 
    helm repo add {{helm_chart_repo}} {{helm_chart_url}}
    helm upgrade --install {{applicationName}}-{{environment}} {{helm_chart_repo}}/{{helm_chart_name}} {%- if helm_chart_version != '' %}--version {{helm_chart_version}}{%- endif %} {%- if helm_values_path != '' %} -f {{helm_values_path}} {%- endif %} --namespace {{namespace}} --atomic --timeout {{deployment_timeout}}
    {%- endif %}
- id: 'Extract summary vars'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    echo "###pipeline-summary-start###" >> summary.txt 2>&1;
    echo "###pipeline-summary-end###" >> summary.txt 2>&1;
    cat summary.txt;
{% else %}
- id: 'Uninstall application'
  name: 'gcr.io/$PROJECT_ID/helm'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    helm uninstall {{applicationName}}-{{environment}} --namespace {{namespace}};
{% endif %}
