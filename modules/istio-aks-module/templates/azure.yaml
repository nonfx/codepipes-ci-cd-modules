{% set workspace = '' %}   {# has to be a persistent volume #}
{% set pipeline_env_file = workspace|add:'.env' %}
{% set pipeline_secret_file = workspace|add:'.secret.env' %}
{% set pipeline_modules_path = workspace|add:'pipeline_modules' %}
{% set helm_chart_path = pipeline_modules_path|add:"/helm/azure/istio-aks" %}

steps:
  - task: HelmInstaller@0
    inputs:
      helmVersion: {{helmVersion}}
      installKubectl: true
      kubectlVersion: {{kubectlVersion}}
  - script: |
        az login --service-principal -u $(ARM_CLIENT_ID) -p $(ARM_CLIENT_SECRET) --tenant $(ARM_TENANT_ID)
        az aks get-credentials --name {{cluster}} --resource-group {{resourceGroup}} --subscription $(ARM_SUBSCRIPTION_ID) --overwrite-existing -a
    displayName: "Get AKS Kubecofing"
    workingDirectory: {{ workingDir }}
  {% if job_type == 'deploy' %}
  - script: |
        export PATH="{{workspace}}/bin:$$PATH";
        cp {{pipeline_env_file}} {{helm_chart_path}} 2>/dev/null || :;
        cp {{pipeline_secret_file}} {{helm_chart_path}} 2>/dev/null || :;
        cd {{helm_chart_path}} ;
        touch .helmignore;
        rm -f values.yaml;
        if [ -z "$(docker_registry)" ]; then
          export docker_registry="index.docker.io"
        fi
        echo "projectName: {{projectName}}
        applicationName: {{applicationName}} #auto
        environment:  {{environment}} #auto
        project: {{project}} #auto
        manageCertificate: {{manageCertificate}}
        {% if istioInjection %}
        istioInjection: enabled
        {% else %}
        istioInjection: disabled
        {% endif %}
        {% if deployment %}
        deploy:
          replicaCount: {{replicaCount}}
          strategy: RollingUpdate
          maxUnavail: {{maxUnavail}}
          maxSurge: {{maxSurge}}
          terminationGracePeriodSeconds: {{terminationGracePeriodSeconds}}
          healthCheck:
            liveFailThreshold: '{{liveFailThreshold}}'
            liveSuccThreshold: '{{liveSuccThreshold}}'
            readFailThreshold: '{{readFailThreshold}}'
            readSuccThreshold: '{{readSuccThreshold}}'
            delay: '{{probeDelay}}'
            period: '{{probePeriod}}'
            timeout: '{{probeTimeout}}'

        image: #auto
          repository: {{ repository }}
          pullPolicy: Always
          tag:  {{ tag }}
          registryCredentials:
            registry: $docker_registry
            username: $(docker_username)" >> values.yaml

        printf '    password: %s\n' "$(printf '%s' "$(docker_password)" | jq -aRs .)" >> values.yaml

        echo "
        {% endif %}
        {% if ports %}
        ports:
        {% for port in ports%}
          - name: {{port.name}}
            containerPort: {{port.containerPort}}
            protocol: {{port.protocol}}
            {% if port.healthCheck %}
            healthcheck: {{port.healthCheck}}
            {% endif %}
        {% endfor %}
        {% endif %}

        {% if ports %}
        service:
          type: {{ service_port }}
          private: false
          neg: {{ serviceAccountEnabled | lower }}
        {% endif %}

        {% if domains %}
        domains:
        {% for domain in domains %}
        - name: {{domain.name}}
        {% endfor %}
        {% endif %}

        {% if virtualService %}
        virtualService:
        {% for vs in virtualService %}
          prefix: {{vs.prefix}}
          rewrite:
            enabled: {{vs.rewriteEnabled | lower }}
            value: {{vs.rewriteValue}}
        {% endfor %}
        {% endif %}

        {% if ingressIP %}
        ingress:
          {% if ingressIPName %}
          staticIPName: {{ingressIPName}}
          {% endif %}
          staticIP: {{ingressIP}}
        {% endif %}


        autoscaling:
          enabled: {{autoscalingEnabled}}
          minReplicas: {{minReplicas}}
          maxReplicas: {{maxReplicas}}
          targetCPUUtilizationPercentage: {{targetCPUUtilizationPercentage}}

        resourcequota:
          quotaRequestsCpu: 100
          quotaRequestsMem: 0.2
          quotaLimitsCpu: 200
          quotaLimitsMem: 0.3

        resources:
          limits:
            cpu: {{cpuLimit}}
            memory: {{memoryLimit}}
          requests:
            cpu: {{cpuRequest}}
            memory: {{memoryRequest}}

        lifecycle:
          prestop:
            command: ['/bin/sh', '-c', 'sleep 30']

        artifacts:
        {% for mountPath, fs in files %}
          - mountPath: {{mountPath}}
            files:
            {% for file in fs %}
              - '{{file}}'
            {% endfor %}
        {% endfor %}
        envs:" >> values.yaml;
        cat {{pipeline_env_file}} | while IFS= read -r line; do
        value=${line#*=}
        name=${line%%=*}
        printf '  %s: %s\n' $name "$value" >> values.yaml
        done;
        echo "secrets:" >> values.yaml;
        cat {{pipeline_secret_file}} | while IFS= read -r line; do
        value=${line#*=}
        name=${line%%=*}
        printf '  %s: %s\n' $name $value >> values.yaml
        done;
    displayName: "Generate values file"
    workingDirectory: {{ workingDir }}
  - script: |
          ls -la;
          cd {{helm_chart_path}} ;
          ls -la;
          cat values.yaml;
          helm upgrade --install -f values.yaml {{applicationName}}-{{environment}} . #--atomic --timeout {{deployment_timeout}}
    displayName: "Helm Deploy {{applicationName}}"
    workingDirectory: {{ workingDir }}
  {% else %}
  - script: |
          cd {{helm_chart_path}} ;
          helm list;
          helm uninstall {{applicationName}}-{{environment}};
    displayName: "Helm Uninstall {{applicationName}}"
    workingDirectory: {{ workingDir }}
  {% endif %}
