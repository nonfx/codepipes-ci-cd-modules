steps:
  - script: |
      # because sonar needs the base branch fetched for comparison
      git fetch --all
    displayName: 'Git fetch base'
    workingDirectory: {{ git_local_path }}
  - task: SonarCloudPrepare@1
    inputs:
      SonarCloud: {{ sonar_cloud_service_connection }}
      organization: {{ sonar_cloud_org }}
      scannerMode: 'CLI'
      {% if sonar_config_file -%}
      configMode: 'file'
      configFile: {{ git_local_path }}/{{ sonar_config_file }}
      {% else -%}
      configMode: 'manual'
      cliProjectKey: {{ sonar_cloud_project_key }}
      {%- endif %}
      extraProperties: |
        sonar.projectBaseDir={{ git_local_path }}
        {% if git_checkout_target -%}
        sonar.scm.revision={{ git_checkout_target }}
        sonar.branch.name={{ git_checkout_target }}
        {%- endif %}
  - task: SonarCloudAnalyze@1
  - task: SonarCloudPublish@1
  - task: sonarcloud-buildbreaker@2
    inputs:
      SonarCloud: {{ sonar_cloud_service_connection }}
      organization: {{ sonar_cloud_org }}
