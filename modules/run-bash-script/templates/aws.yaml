{% set workspace = '$CODEBUILD_SRC_DIR' %}   {# has to be a persistent volume #}
{% set pipeline_env_file = workspace|add:'/.env' %}
{% set pipeline_secret_env_file = workspace|add:'/.secret.env' %}
{% set source_code_path = workspace|add:'/source_code' %}
version: 0.2
env:
  variables:
    CODEPIPES_DEPLOY_ACTION: "{{ job_type }}"
phases:
  build:
    commands:
      - if [ -f {{ pipeline_env_file }} ]; then source {{ pipeline_env_file }}; fi
      - if [ -f {{ pipeline_secret_env_file }} ]; then source {{ pipeline_secret_env_file }}; fi
      - cd {{ source_code_path }}/{{ repo_dir }}
      - ./{{ bash_script }} {% for param in script_parameters %}{{param}} {% endfor %}
  post_build:
    commands:
      - echo "###pipeline-summary-start###" >> summary.txt 2>&1
      {% if pipeline_summary_var %}
      - {% for summary in pipeline_summary_var %} {{ summary.Command }} | xargs -0 printf "{{ summary.Name }}=%s\n" >>  summary.txt 2>&1; {% endfor %}
      {% endif %}
      - echo "Completion Status=[bash script completed {{ job_type }} at $(date)]" >> summary.txt 2>&1
      - echo "###pipeline-summary-end###" >> summary.txt 2>&1
      - cat summary.txt
