########################################################################################################################################################
# The template uses serverless framework to deploy function to lambdas using container images                                                          #
# Uses serverless-deployment-bucket plugin to keep iac code                                                                                            #
# Uses machine env from .env file https://www.serverless.com/framework/docs/environment-variables                                                           #
########################################################################################################################################################
{% set workspace = '$CODEBUILD_SRC_DIR' %}   {# has to be a persistent volume #}
{% set pipeline_env_file = workspace|add:'/.env' %}

version: 0.2
phases:
  install:
    commands:
      - aws configure set region {{region}}
      - npm install -g npm
      - npm install serverless -g
      - npm install serverless-deployment-bucket -g
  build: 
    commands:
      - |
        echo "
        service: {{applicationName}}
        useDotenv: true
        frameworkVersion: '3'
        provider:
          name: aws
          stage: {{environment}}
          ecr:
            images: 
              {{ function }}:
                uri: {{repository}}:{{tag}}
          architecture: {{architecture}}
          memorySize: {{memory}}
          timeout: {{timeout}}
          deploymentBucket:
            name: {{ bucket }}
        functions:
          {{ function }}:
            image:
              name: {{ function }}
            events:
              - httpApi:
                  path: {{ path }}
                  method: {{ verb }} 
        plugins:
          - serverless-deployment-bucket  
        " >> serverless.yml
    {% if job_type == 'deploy' %}
      - serverless deploy
    {% else %}
      - serverless remove
    {% endif %}
  {% if job_type == 'deploy' %}
  post_build:
    commands:
      - echo "###pipeline-summary-start###" >> summary.txt 2>&1;
      - |
        grab=$(sls info | sed -n "/endpoint:/,/functions:/p" | sed 's/endpoint:/ /g' | sed 's/functions:/ /g' | xargs)
        count=1
        while IFS= read -r line; do
            replaceTxt='='
            echo "$count ${line/ - /$replaceTxt}" >> summary.txt 
            let "count+=1" 
        done <<< "$grab"
      - echo "###pipeline-summary-end###" >> summary.txt 2>&1;
      - cat summary.txt
  {% endif %}