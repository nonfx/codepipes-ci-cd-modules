provisioner: gcp
name: pipeline-config-gcp
version: 1
revision: 1
displayName: Configure Pipeline
description: Configure global pipeline options and environment.
target: config
keywords:
  - env
  - environment
  - secret
  - config
  - configuration
author: CloudCover
meta:
  gcpRoles:
    - roles/cloudkms.cryptoKeyDecrypter
inputs:
  properties:
    pipeline_disk_size_gb:
      title: Disk Size [GB]
      description: Amount of disk space in GB allocated for the pipeline.
      type: integer
      default: 300
      maximum: 1000
    pipeline_env:
      title: Global Environment
      description: Mapping of globally available variables to values.
      type: object
      default: {}
    pipeline_logs_bucket:
      title: Logs Bucket
      description: Cloud Storage bucket for logs generated by the pipeline.
      type: string
      default: ""
    pipeline_machine_type:
      title: Machine Type
      description: Type of the VM used to run the pipeline.
      type: string
      default: UNSPECIFIED
    pipeline_secret_env:
      title: Global Secret Environment
      description: Mapping of globally available variables to encrypted values.
      type: object
      default: {}
    pipeline_secret_env_key:
      title: Secret Environment Encryption Key
      description: Name of a KMS key used to encrypt secret values.
      type: string
      default: ""
    pipeline_tags:
      title: Tags
      description: Tags assigned to the pipeline.
      type: array
      default: []
      items:
        type: string
    pipeline_timeout_sec:
      title: Timeout [s]
      description: Amount of time in seconds the pipeline will be allowed to run.
      type: integer
      default: 4000
      maximum: 86400 # 24*60*60
      minimum: 0
    pipeline_queue_timeout_sec:
      title: Queue Timeout [s]
      description: Amount of time in seconds the pipeline will be allowed to be queued waiting to run.
      type: integer
      default: 7200
    pipeline_module_git:
      title: Pipeline module git repo url
      description: git url for cloning the pipeline module repo.
      type: string
    pipeline_module_git_rev:
      title: Pipeline module git repo revision
      description: git revision for cloning the pipeline module repo.
      type: string
    tag:
      title: Tag of either container or artifact
      description: git revision for cloning the pipeline module repo.
      type: string
    repo_dir:
      title: Repo Dir
      description: Repo Dir
      type: string
    repository:
      title: Artifact repository
      description: Artifact repository (docker repo for containerImage or Git repo for GitCode)
      type: string
  internal:
    - pipeline_env
    - pipeline_secret_env
    - pipeline_secret_env_key
    - pipeline_module_git
    - pipeline_module_git_rev
    - tag
    - repo_dir
    - repository
template: |
  timeout: {{ pipeline_timeout_sec }}s
  queueTtl: {{ pipeline_queue_timeout_sec }}s
  {% if pipeline_logs_bucket %}logsBucket: 'gs://{{ pipeline_logs_bucket }}'{% endif %}
  tags:
  {% for tag in pipeline_tags %}
  - {{tag}}
  {% endfor %}
  options:
   {% if pipeline_machine_type %}machineType: {{ pipeline_machine_type }}{% endif %}
   {% if pipeline_disk_size_gb %}diskSizeGb: '{{ pipeline_disk_size_gb }}'{% endif %}
   env:
   {% for env_key, env_value in pipeline_env %}
   - '{{env_key}}={{ env_value }}'
   {% endfor %}
   secretEnv:
     {% for env_key in pipeline_secret_env %}
     - {{env_key}}
     {% endfor %}
  {% if pipeline_secret_env && pipeline_secret_env_key %}
  secrets:
  - kmsKeyName: {{ pipeline_secret_env_key }}
    secretEnv:
      {% for env_key, env_value in pipeline_secret_env %}
      {{env_key}}: '{{ env_value }}'
      {% endfor %}
  {% endif %}
