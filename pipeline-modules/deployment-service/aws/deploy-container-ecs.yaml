provisioner: aws
name: deploy-container-ecs
version: 1
revision: 1
displayName: "App ECS deployment"
description: "AWS ECS Deployment template"
target: "deployment-template"
keywords: ["bash", "linux" , "ecs aws container"]
author: "CloudCover"
meta:
  inputArtifactType:
    - ContainerImage
inputs:
  type: object
  properties:
    region:
      title: Region name
      description: region name for cluster
      type: string
    app_env:
      title: Application Environment
      description: Application Related Envs
      type: object
      default: {}
    repository:
      title: Container Repository
      description: Enter Full container url without tag
      type: string
      default: ""
    tag:
      title: Container tag
      description: Tagged container will deploy
      type: string
      default: latest
    applicationName:
      title: Application name
      description: This is vanguard application name
      type: string
      default: latest
    environment:
      title: Environment Name
      description: This is vanguard environment name
      type: string
      default: latest
    project:
      title: Project Name
      description: This is a vanguard project name
      type: string
      default: latest
    job_type:
      title: Job Type
      description: This is to deploy or undeploy application
      type: string
      default: deploy
    task_name:
      title: Task Name
      description: The ECS Task Name to update
      type: string
    service_name:
      title: Service Name
      description: The ECS Service Name to deploy to
      type: string
    cluster_name:
      title: Cluster Name
      description: The ECS Cluster Name to Deploy to
      type: string
    account_id:
      title: Account ID
      description: The AWS Account ID where ECS is
      type: string
    image_name:
      title: Image Name
      description: The container image name to be deployed
      type: string
  required: ["region","task_name","service_name","cluster_name","account_id","image_name"]
  internal:
    - repository
    - tag
    - applicationName
    - environment
    - project
    - job_type
template: |
  ########################################################################################################################################################
  # The module creates json config file for source configuration and instance configuration                                                              #
  # The module recieves a formatted list of pipeline env in {{ pipeline_env_file }},                                                                     #
  # So we don't have to worry about character escaping in this module.                                                                                   #
  ########################################################################################################################################################
  {% set workspace = '$CODEBUILD_SRC_DIR' %}   {# has to be a persistent volume #}
  {% set pipeline_env_file = workspace|add:'/.env' %}
  
  version: 0.2
  phases:
    install:
      commands:
        - aws configure set region {{region}}
    build:
      commands:
        - echo Setting configurations
        - TASK_NAME={{task_name}}
        - SERVICE_NAME={{service_name}}
        - CLUSTER_NAME={{cluster_name}}
        - REGION={{region}}
        - VERSION=1.0
        - ACCOUNT_NUMBER={{account_id}}
        - NEW_IMAGE={{image_name}}
        - echo Updating ECS
        - TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition "$TASK_NAME" --region "$REGION")
        - NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq --arg IMAGE "$NEW_IMAGE" '.taskDefinition | .containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.requiresAttributes) | del(.compatibilities) | del(.registeredAt) | del(.registeredBy)')
        - NEW_REVISION=$(aws ecs register-task-definition --region "$REGION" --cli-input-json "$NEW_TASK_DEFINITION")
        - NEW_REVISION_DATA=$(echo $NEW_REVISION | jq '.taskDefinition.revision')
        - NEW_SERVICE=$(aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_NAME --force-new-deployment)
        - echo "done"
        - echo "${TASK_NAME}, Revision: ${NEW_REVISION_DATA}"
  {% if (not vpc_config) or vpc_config|length == 0 or vpc_config.vpcId == "" %}
  vpcconfig: null
  {% else %}
  vpcconfig: {{ vpc_config|cpi_json }}
  {% endif %}
