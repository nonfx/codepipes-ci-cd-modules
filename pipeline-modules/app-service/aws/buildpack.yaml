provisioner: aws
name: build-docker-image
version: 1
revision: 1
displayName: Docker Build and Push
description: This plugin is for Docker build & push. Uses Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python. 
target: ""
category: containerise
keywords:
  - Docker
  - Push
  - Build
author: CloudCover
meta: {}
inputs:
  properties:
    container_repository:
      title: Container repository
      description: Complete repository path
      type: string
    container_tag:
      title: Image Tag
      description: Tag name for the container image
      type: string
      default: latest
    docker_build_args:
      title: Docker Build Arguments
      description: Arguments for the docker build command
      type: array
      default: []
      items:
        type: string
    working_dir:
      title: Working directory
      description: The current working directory to execute command
      type: string
      default: repo
    use_github_tag:
      title: Use github tag
      description: true value will push the image reference with git commit sha tag as well
      type: boolean
      default: true
    sha_tag:
      title: SHA Git commit tag
      description: Resloved Commit hash for Input git artifact
      type: string    
    default_builder:
      title: Default Builder to use
      description: Builder to build docker image from code automatically. Default builder is Google's Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python.
      type: string   
      default: "gcr.io/buildpacks/builder:v1"    
  internal:
    - container_repository
    - container_tag
    - sha_tag
template: |
  version: 0.2

  phases:
    build:
      commands:
        - echo Getting build packs
        - sudo add-apt-repository ppa:cncf-buildpacks/pack-cli
        - sudo apt-get update
        - sudo apt-get install pack-cli
        - echo Building image
        - pack config default-builder {{default_builder}}
        - pack build {{container_repository}}:{{container_tag}}
        - echo Logging in to docker
        - echo $docker_password | docker login -u $docker_username --password-stdin $docker_registry
        - echo Build started on `date`
        - echo Building the Docker image...
        - echo Build completed on `date`
        - echo Pushing the Docker image...
        - docker push {{container_repository}}:{{container_tag}}
        {% if use_github_tag %}
        - echo Building the Docker image with Commit hash...
        - docker tag {{container_repository}}:{{container_tag}} {{container_repository}}:{{sha_tag}}
        - echo Build completed on `date`
        - echo Pushing the Docker image with Commit hash...
        - docker push {{container_repository}}:{{sha_tag}}
        {% endif %}